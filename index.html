<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Lapor Mangan! - Purwokerto</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    :root {
      --red: #c53e4e;
      --light-red: #d8c2cf;
      --bg: #f8f9fa;
      --white: #ffffff;
      --text: #333;
      --blue: #2980b9;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', sans-serif; }
    body { background: var(--bg); color: var(--text); }

    header {
      background: var(--red);
      color: var(--white);
      padding: 15px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      position: relative;
    }

    .header-content {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
    }

    header img { height: 40px; }

    .weather-info {
      background: rgba(255, 255, 255, 0.2);
      padding: 8px 12px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(5px);
    }

    .weather-info:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .weather-icon {
      font-size: 20px;
    }

    .weather-temp {
      font-weight: 600;
      font-size: 16px;
    }

    .weather-details {
      position: absolute;
      top: 100%;
      right: 20px;
      background: white;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      z-index: 1000;
      width: 250px;
      display: none;
      color: var(--text);
    }

    .weather-details.show {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .weather-details-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .weather-details-main {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
    }

    .weather-details-icon {
      font-size: 40px;
      color: var(--blue);
    }

    .weather-details-temp {
      font-size: 28px;
      font-weight: 600;
    }

    .weather-details-desc {
      text-transform: capitalize;
    }

    .weather-details-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .weather-stat {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 14px;
    }

    .weather-stat i {
      color: var(--blue);
      width: 20px;
      text-align: center;
    }

    #map {
      height: 60vh;
      width: 100%;
    }

    .container {
      padding: 20px;
      max-width: 800px;
      margin: auto;
    }

    .filter-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .filter-bar input,
    .filter-bar select,
    .filter-bar button {
      flex: 1;
      padding: 10px;
      border: 1px solid var(--light-red);
      border-radius: 8px;
    }

    .filter-bar button {
      background: var(--red);
      color: white;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .filter-bar button:hover {
      background: #b03545;
    }

    .card {
      background: var(--white);
      border-left: 5px solid var(--red);
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .card:hover { transform: translateY(-3px); }

    .card h3 { color: var(--red); }
    .card small { color: #666; }

    .detail-popup {
      display: none;
      position: fixed;
      top: 10%;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      z-index: 9999;
      max-width: 400px;
      width: 90%;
    }

    .detail-popup img {
      width: 100%;
      border-radius: 8px;
      margin-top: 10px;
    }

    .close-btn {
      float: right;
      cursor: pointer;
      font-size: 20px;
      color: var(--red);
    }

    .chatbot {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--red);
      color: white;
      border-radius: 50%;
      padding: 15px;
      cursor: pointer;
      z-index: 999;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      transition: transform 0.3s ease;
    }

    .chatbot:hover {
      transform: scale(1.1);
    }

    /* LINE-style Chat Interface */
    .chat-popup {
      display: none;
      position: fixed;
      bottom: 80px;
      right: 20px;
      background: white;
      border-radius: 15px;
      width: 300px;
      height: 400px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      overflow: hidden;
      flex-direction: column;
      z-index: 999;
    }

    .chat-header {
      background: #00B900;
      color: white;
      padding: 12px 15px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chat-close {
      cursor: pointer;
      font-size: 20px;
    }

    .chat-messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      background: #e5ddd5;
      background-image: url('https://web.line.me/static/desktop/2.1.0/img/bg_chat.5f8e3b6.png');
      background-size: cover;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
      max-height: 300px;
      min-height: 200px;
    }

    .message {
      margin-bottom: 10px;
      max-width: 80%;
      padding: 8px 12px;
      border-radius: 18px;
      line-height: 1.4;
      position: relative;
      word-wrap: break-word;
    }

    .message-user {
      background: #DCF8C6;
      margin-left: auto;
      margin-right: 5px;
      border-top-right-radius: 5px;
    }

    .message-bot {
      background: white;
      margin-right: auto;
      margin-left: 5px;
      border-top-left-radius: 5px;
    }

    .typing-indicator {
      background: white !important;
      margin-right: auto;
      margin-left: 5px;
      border-top-left-radius: 5px;
      padding: 12px 16px;
    }

    .typing-dots {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .typing-dots span {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #999;
      animation: typing 1.4s infinite ease-in-out;
    }

    .typing-dots span:nth-child(1) {
      animation-delay: -0.32s;
    }

    .typing-dots span:nth-child(2) {
      animation-delay: -0.16s;
    }

    @keyframes typing {
      0%, 80%, 100% {
        transform: scale(0.8);
        opacity: 0.5;
      }
      40% {
        transform: scale(1);
        opacity: 1;
      }
    }

    .message-time {
      font-size: 10px;
      color: #666;
      margin-top: 3px;
      text-align: right;
    }

    .chat-input-container {
      display: flex;
      padding: 10px;
      background: white;
      border-top: 1px solid #ddd;
    }

    .chat-input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 20px;
      outline: none;
    }

    .chat-send {
      background: #00B900;
      color: white;
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      margin-left: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    @media (max-width: 768px) {
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .weather-info {
        margin-top: 10px;
        align-self: flex-end;
      }
      
      .weather-details {
        right: 10px;
        left: 10px;
        width: auto;
      }
      
      .filter-bar { flex-direction: column; }
      .detail-popup { top: 5%; }
      .chat-popup {
        width: 90%;
        right: 5%;
        bottom: 70px;
      }
    }

    @media (max-width: 480px) {
      .header-content h1 {
        font-size: 20px;
      }
      
      .weather-info {
        padding: 6px 10px;
        font-size: 14px;
      }
      
      .weather-icon {
        font-size: 16px;
      }
    }
  </style>
</head>
<body>

  <header>
    <div class="header-content">
      <h1>Lapor Mangan! - Purwokerto</h1>
    </div>
    
    <div class="weather-info" id="weatherInfo" onclick="toggleWeatherDetails()">
      <i class="fas fa-cloud-sun weather-icon" id="weatherIcon"></i>
      <span class="weather-temp" id="weatherTemp">--¬∞C</span>
    </div>
    
    <div class="weather-details" id="weatherDetails">
      <div class="weather-details-header">
        <h3>Cuaca Purwokerto</h3>
        <small id="weatherDate">Hari ini</small>
      </div>
      <div class="weather-details-main">
        <i class="fas fa-cloud-sun weather-details-icon" id="weatherDetailsIcon"></i>
        <div>
          <div class="weather-details-temp" id="weatherDetailsTemp">--¬∞C</div>
          <div class="weather-details-desc" id="weatherDetailsDesc">--</div>
        </div>
      </div>
      <div class="weather-details-stats">
        <div class="weather-stat">
          <i class="fas fa-temperature-low"></i>
          <span>Min: <span id="weatherMinTemp">--¬∞C</span></span>
        </div>
        <div class="weather-stat">
          <i class="fas fa-temperature-high"></i>
          <span>Max: <span id="weatherMaxTemp">--¬∞C</span></span>
        </div>
        <div class="weather-stat">
          <i class="fas fa-tint"></i>
          <span>Kelembapan: <span id="weatherHumidity">--%</span></span>
        </div>
        <div class="weather-stat">
          <i class="fas fa-wind"></i>
          <span>Angin: <span id="weatherWind">-- m/s</span></span>
        </div>
      </div>
    </div>
  </header>

  <div id="map"></div>

  <div class="container">
    <div class="filter-bar">
      <input id="search" placeholder="Cari nama kuliner..." />
      <select id="filter">
        <option value="">Semua</option>
        <option value="Soto">Soto</option>
        <option value="Gorengan">Gorengan</option>
        <option value="Jajanan Tradisional">Jajanan Tradisional</option>
        <option value="Camilan Kering">Camilan Kering</option>
        <option value="Kue Tradisional">Kue Tradisional</option>
        <option value="Kuliner Unik">Kuliner Unik</option>
        <option value="Sayuran">Sayuran</option>
        <option value="Dodol">Dodol</option>
        <option value="Kue Kering">Kue Kering</option>
        <option value="Makanan Ringan">Makanan Ringan</option>
        <option value="Camilan">Camilan</option>
        <option value="Camilan Manis">Camilan Manis</option>
        <option value="Minuman">Minuman</option>
      </select>
      <button onclick="showWeatherRec()">Rekomendasi Cuaca</button>
    </div>

    <div id="list"></div>
  </div>

  <!-- Detail Popup -->
  <div class="detail-popup" id="detailPopup">
    <span class="close-btn" onclick="closeDetail()">√ó</span>
    <div id="detailContent"></div>
  </div>

  <!-- LINE-style Chatbot -->
  <div class="chatbot" onclick="toggleChat()">üí¨</div>
  <div class="chat-popup" id="chatPopup">
    <div class="chat-header">
      <span>MakanBot</span>
      <span class="chat-close" onclick="toggleChat()">√ó</span>
    </div>
    <div class="chat-messages" id="chatMessages">
      <div class="message message-bot">
        <span id="initialGreeting">Halo! Ada yang bisa saya bantu cari kuliner di Purwokerto?</span>
        <div class="message-time">8:23 PM</div>
      </div>
    </div>
    <div class="chat-input-container">
      <input type="text" class="chat-input" id="chatInput" placeholder="Ketik pesan..." onkeypress="if(event.key=='Enter') sendChat()">
      <button class="chat-send" onclick="sendChat()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M22 2L11 13" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const kulinerData = [
      {
        nama: "Soto Sokaraja",
        kategori: "Soto",
        alamat: "Jl. Sokaraja, Purwokerto",
        jam: "07:00 - 15:00",
        harga: "Rp 12.000 - 20.000",
        deskripsi: "Kuah kaldu sapi + kacang, disajikan dengan ketupat dan kerupuk.",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Tersedia",
        rute: "Area Sokaraja",
        lat: -7.4220,
        lng: 109.2300,
        keliling: false
      },
      {
        nama: "Tempe Mendoan",
        kategori: "Gorengan",
        alamat: "Pasar Sokaraja, Purwokerto",
        jam: "06:00 - 18:00",
        harga: "Rp 2.000 - 5.000",
        deskripsi: "Tempe digoreng setengah matang, renyah di luar lembut di dalam.",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Tersedia",
        rute: "Pasar Sokaraja",
        lat: -7.4200,
        lng: 109.2300,
        keliling: true
      },
      {
        nama: "Getuk Goreng",
        kategori: "Jajanan Tradisional",
        alamat: "Jl. Sudirman, Purwokerto",
        jam: "08:00 - 17:00",
        harga: "Rp 5.000 - 10.000",
        deskripsi: "Singkong digoreng, isi gula aren, renyah di luar lembut di dalam.",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Ya",
        rute: "Jl. Sudirman - Alun-Alun",
        lat: -7.4210,
        lng: 109.2400,
        keliling: true
      },
      {
        nama: "Klanting",
        kategori: "Camilan Kering",
        alamat: "Pasar Baru, Purwokerto",
        jam: "09:00 - 17:00",
        harga: "Rp 5.000 - 10.000",
        deskripsi: "Cemilan singkong berbentuk anting, asin gurih.",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Ya",
        rute: "Pasar Baru - Terminal",
        lat: -7.4250,
        lng: 109.2350,
        keliling: true
      },
      {
        nama: "Cenil",
        kategori: "Jajanan Tradisional",
        alamat: "Jl. Dr. Soeparno, Purwokerto",
        jam: "08:00 - 16:00",
        harga: "Rp 3.000 - 5.000",
        deskripsi: "Singkong berwarna-warni, kenyal, ditaburi kelapa.",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Tidak",
        rute: "Sekitar kampus UNSOED",
        lat: -7.4300,
        lng: 109.2450,
        keliling: true
      },
      {
        nama: "Nopia",
        kategori: "Kue Tradisional",
        alamat: "Jl. Sudirman, Purwokerto",
        jam: "07:00 - 18:00",
        harga: "Rp 3.000 - 6.000",
        deskripsi: "Kue isi gula merah, kacang, atau cokelat, dipanggang di tungku.",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Ya",
        rute: "Jl. Sudirman - Pasar Wage",
        lat: -7.4180,
        lng: 109.2380,
        keliling: true
      },
      {
        nama: "Kraca",
        kategori: "Kuliner Unik",
        alamat: "Pasar Malam Purwokerto",
        jam: "18:00 - 23:00",
        harga: "Rp 8.000 - 12.000",
        deskripsi: "Keong kecil dimasak pedas, dijual di pinggir jalan malam.",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Tidak",
        rute: "Pasar Malam - Alun-Alun",
        lat: -7.4200,
        lng: 109.2500,
        keliling: true
      },
      {
        nama: "Kuluban / Kluban",
        kategori: "Sayuran",
        alamat: "Jl. HR Bunyamin, Purwokerto",
        jam: "10:00 - 15:00",
        harga: "Rp 8.000 - 12.000",
        deskripsi: "Sayuran rebus + sambal kelapa, mirip salad.",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Ya",
        rute: "Jl. HR Bunyamin - Pasar Kliwon",
        lat: -7.4160,
        lng: 109.2320,
        keliling: false
      },
      {
        nama: "Jenang Jaket",
        kategori: "Dodol",
        alamat: "Pasar Wage, Purwokerto",
        jam: "08:00 - 16:00",
        harga: "Rp 5.000 - 10.000",
        deskripsi: "Tepung ketan + santan + gula merah, lembut dan manis.",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Ya",
        rute: "Pasar Wage - Terminal",
        lat: -7.4270,
        lng: 109.2400,
        keliling: true
      },
      {
        nama: "Jalabiya",
        kategori: "Kue Kering",
        alamat: "Jl. Pramuka, Purwokerto",
        jam: "09:00 - 17:00",
        harga: "Rp 4.000 - 7.000",
        deskripsi: "Singkong isi gula merah, bentuk seperti donat.",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Tidak",
        rute: "Jl. Pramuka - Pasar Baru",
        lat: -7.4220,
        lng: 109.2360,
        keliling: true
      },
      {
        nama: "Sahoun",
        kategori: "Makanan Ringan",
        alamat: "Jl. Gatot Subroto, Purwokerto",
        jam: "10:00 - 16:00",
        harga: "Rp 8.000 - 12.000",
        deskripsi: "Soun berkuah ayam, kenyal dan gurih.",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Ya",
        rute: "Jl. Gatot Subroto - Kampus UNSOED",
        lat: -7.4190,
        lng: 109.2320,
        keliling: false
      },
      {
        nama: "Wajik Kletik",
        kategori: "Camilan Manis",
        alamat: "Jl. Dr. Cipto, Purwokerto",
        jam: "08:00 - 17:00",
        harga: "Rp 3.000 - 6.000",
        deskripsi: "Wajik kenyal dari gula jawa.",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Tidak",
        rute: "Jl. Dr. Cipto - Pasar Kliwon",
        lat: -7.4240,
        lng: 109.2380,
        keliling: true
      },
      {
        nama: "Combro",
        kategori: "Camilan",
        alamat: "Jl. HR Bunyamin, Purwokerto",
        jam: "07:00 - 18:00",
        harga: "Rp 3.000 - 5.000",
        deskripsi: "Singkong isi oncom pedas, goreng renyah.",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Ya",
        rute: "Jl. HR Bunyamin - Alun-Alun",
        lat: -7.4180,
        lng: 109.2300,
        keliling: true
      },
      {
        nama: "Lumpia Boom",
        kategori: "Makanan Ringan",
        alamat: "Jl. Sudirman, Purwokerto",
        jam: "09:00 - 18:00",
        harga: "Rp 10.000 - 15.000",
        deskripsi: "Lumpia besar isi sayur, telur, ayam, dll.",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Ya",
        rute: "Jl. Sudirman - Pasar Wage",
        lat: -7.4210,
        lng: 109.2410,
        keliling: true
      },
      {
        nama: "Cimplung",
        kategori: "Camilan",
        alamat: "Jl. Pramuka, Purwokerto",
        jam: "08:00 - 16:00",
        harga: "Rp 3.000 - 5.000",
        deskripsi: "Singkong + kelapa + gula aren, manis dan gurih.",
        foto: "https://i.imgur.com/8z3L5kL.jpg",
        parkir: "Tidak",
        rute: "Jl. Pramuka - Terminal",
        lat: -7.4250,
        lng: 109.2340,
        keliling: true
      }
    ];

    // Initialize map centered on Purwokerto
    const map = L.map('map').setView([-7.4212, 109.2422], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    let markers = [];

    // OpenWeatherMap API Key and Purwokerto coordinates
    const API_KEY = '360cd1393e0f16a61618fd4e441a39b8';
    const PURWOKERTO_LAT = -7.4212;
    const PURWOKERTO_LON = 109.2422;

    // Weather icons mapping
    const weatherIcons = {
      '01d': 'fas fa-sun',           // clear sky (day)
      '01n': 'fas fa-moon',          // clear sky (night)
      '02d': 'fas fa-cloud-sun',     // few clouds (day)
      '02n': 'fas fa-cloud-moon',    // few clouds (night)
      '03d': 'fas fa-cloud',         // scattered clouds
      '03n': 'fas fa-cloud',
      '04d': 'fas fa-cloud',         // broken clouds
      '04n': 'fas fa-cloud',
      '09d': 'fas fa-cloud-rain',    // shower rain
      '09n': 'fas fa-cloud-rain',
      '10d': 'fas fa-cloud-sun-rain',// rain (day)
      '10n': 'fas fa-cloud-moon-rain',// rain (night)
      '11d': 'fas fa-bolt',         // thunderstorm
      '11n': 'fas fa-bolt',
      '13d': 'fas fa-snowflake',     // snow
      '13n': 'fas fa-snowflake',
      '50d': 'fas fa-smog',         // mist
      '50n': 'fas fa-smog'
    };

    // Fetch weather data
    async function fetchWeather() {
      try {
        const response = await fetch(
          `https://api.openweathermap.org/data/2.5/weather?lat=${PURWOKERTO_LAT}&lon=${PURWOKERTO_LON}&appid=${API_KEY}&units=metric&lang=id`
        );
        
        if (!response.ok) {
          throw new Error('Gagal mengambil data cuaca');
        }
        
        const data = await response.json();
        updateWeatherUI(data);
      } catch (error) {
        console.error('Error fetching weather:', error);
        document.getElementById('weatherIcon').className = 'fas fa-exclamation-triangle weather-icon';
        document.getElementById('weatherTemp').textContent = 'Error';
      }
    }

    // Update weather UI
    function updateWeatherUI(data) {
      const weather = data.weather[0];
      const main = data.main;
      const wind = data.wind;
      
      // Update header weather info
      const iconClass = weatherIcons[weather.icon] || 'fas fa-cloud';
      document.getElementById('weatherIcon').className = iconClass + ' weather-icon';
      document.getElementById('weatherTemp').textContent = `${Math.round(main.temp)}¬∞C`;
      
      // Update weather details
      document.getElementById('weatherDetailsIcon').className = iconClass + ' weather-details-icon';
      document.getElementById('weatherDetailsTemp').textContent = `${Math.round(main.temp)}¬∞C`;
      document.getElementById('weatherDetailsDesc').textContent = weather.description;
      document.getElementById('weatherMinTemp').textContent = `${Math.round(main.temp_min)}¬∞C`;
      document.getElementById('weatherMaxTemp').textContent = `${Math.round(main.temp_max)}¬∞C`;
      document.getElementById('weatherHumidity').textContent = main.humidity;
      document.getElementById('weatherWind').textContent = wind.speed;
      
      // Update date
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      const today = new Date().toLocaleDateString('id-ID', options);
      document.getElementById('weatherDate').textContent = today;
    }

    // Toggle weather details
    function toggleWeatherDetails() {
      const details = document.getElementById('weatherDetails');
      details.classList.toggle('show');
    }

    // Close weather details when clicking outside
    document.addEventListener('click', function(event) {
      const weatherInfo = document.getElementById('weatherInfo');
      const weatherDetails = document.getElementById('weatherDetails');
      
      if (!weatherInfo.contains(event.target) && !weatherDetails.contains(event.target)) {
        weatherDetails.classList.remove('show');
      }
    });

    function renderMap() {
      // Clear existing markers
      markers.forEach(m => map.removeLayer(m));
      markers = [];
      
      // Add new markers
      kulinerData.forEach((item, index) => {
        const icon = item.keliling ? 'üõ∫' : 'üè†';
        const marker = L.marker([item.lat, item.lng], {
          icon: L.divIcon({ 
            html: `<div style="font-size:20px;">${icon}</div>`, 
            className: 'marker-icon', 
            iconSize: [30, 30] 
          })
        }).addTo(map)
          .bindPopup(`<b>${item.nama}</b><br>${item.kategori}`)
          .on('click', () => showDetail(index));
        
        markers.push(marker);
      });
    }

    function renderList(search = "", category = "") {
      const list = document.getElementById("list");
      list.innerHTML = "";
      
      const filteredData = kulinerData.filter(d =>
        d.nama.toLowerCase().includes(search.toLowerCase()) &&
        (category === "" || d.kategori === category)
      );
      
      if (filteredData.length === 0) {
        list.innerHTML = "<p style='text-align:center;'>Tidak ada hasil ditemukan</p>";
        return;
      }
      
      filteredData.forEach((d, i) => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <h3>${d.nama}</h3>
          <p>${d.kategori}</p>
          <small>${d.alamat}</small>
          <small>‚Ä¢ ${d.jam} ‚Ä¢ ${d.harga}</small>
        `;
        div.onclick = () => showDetail(i);
        list.appendChild(div);
      });
    }

    function showDetail(index) {
      const item = kulinerData[index];
      const content = `
        <h3>${item.nama}</h3>
        <p><strong>Kategori:</strong> ${item.kategori}</p>
        <p><strong>Alamat:</strong> ${item.alamat}</p>
        <p><strong>Jam Operasional:</strong> ${item.jam}</p>
        <p><strong>Harga:</strong> ${item.harga}</p>
        <p><strong>Deskripsi:</strong> ${item.deskripsi}</p>
        <p><strong>Parkir:</strong> ${item.parkir}</p>
        <p><strong>Rute:</strong> ${item.rute}</p>
        <p><strong>Tipe:</strong> ${item.keliling ? 'Pedagang Keliling' : 'Warung/Toko Tetap'}</p>
        <img src="${item.foto}" alt="${item.nama}">
      `;
      document.getElementById("detailContent").innerHTML = content;
      document.getElementById("detailPopup").style.display = "block";
      
      // Center map on this item
      map.setView([item.lat, item.lng], 15);
    }

    function closeDetail() {
      document.getElementById("detailPopup").style.display = "none";
    }

    function toggleChat() {
      const chat = document.getElementById("chatPopup");
      chat.style.display = chat.style.display === "block" ? "none" : "block";
      if (chat.style.display === "block") {
        document.getElementById("chatInput").focus();
      }
    }

    // Function to smoothly scroll chat to bottom
    function scrollChatToBottom() {
      const chatMessages = document.getElementById("chatMessages");
      if (chatMessages) {
        // Force scroll to bottom with multiple attempts
        const scrollToBottom = () => {
          chatMessages.scrollTop = chatMessages.scrollHeight;
        };
        
        // Immediate scroll
        scrollToBottom();
        
        // Use requestAnimationFrame for smooth scrolling
        requestAnimationFrame(scrollToBottom);
        
        // Double-check after a short delay
        setTimeout(scrollToBottom, 50);
        
        // Final check after longer delay to ensure content is rendered
        setTimeout(scrollToBottom, 200);
      }
    }

    async function sendChat() {
      const input = document.getElementById("chatInput").value.trim();
      const chatMessages = document.getElementById("chatMessages");

      if (!input) return;

      // Format waktu sekarang
      const now = new Date();
      const hours = now.getHours();
      const minutes = now.getMinutes();
      const ampm = hours >= 12 ? 'PM' : 'AM';
      const formattedHours = hours % 12 || 12;
      const timeString = `${formattedHours}:${minutes < 10 ? '0' + minutes : minutes} ${ampm}`;

      // Tambahkan pesan user
      chatMessages.innerHTML += `
        <div class="message message-user">
          ${input}
          <div class="message-time">${timeString}</div>
        </div>
      `;
      document.getElementById("chatInput").value = "";
      
      // Scroll ke bawah dengan fungsi yang lebih robust
      scrollChatToBottom();

      // Show typing indicator
      const typingIndicator = document.createElement('div');
      typingIndicator.className = 'message message-bot typing-indicator';
      typingIndicator.innerHTML = '<div class="typing-dots"><span></span><span></span><span></span></div>';
      chatMessages.appendChild(typingIndicator);
      scrollChatToBottom();

      try {
        // Enhanced AI response using API
        const reply = await getAIResponse(input);
        
        // Remove typing indicator
        chatMessages.removeChild(typingIndicator);
        
        // Add AI response
        chatMessages.innerHTML += `
          <div class="message message-bot">
            ${reply}
            <div class="message-time">${timeString}</div>
          </div>
        `;
        scrollChatToBottom();
      } catch (error) {
        // Fallback to personalized responses if API fails
        chatMessages.removeChild(typingIndicator);
        
        let reply = "";
        
        // Get personalized context for fallback
        const budget = userContext.budget;
        const mood = userContext.mood;
        const preferences = userContext.preferences;
        const timeOfDay = userContext.timeOfDay;
        
        if (input.toLowerCase().includes("rekomendasi") || input.toLowerCase().includes("sarankan")) {
          if (budget === 'low') {
            reply = "Kak, untuk budget hemat saya sarankan: üçú Tempe Mendoan (Rp 2.000-5.000) di Pasar Sokaraja, ü•§ Es Dawet Ayu (Rp 5.000-8.000), dan üç° Cenil (Rp 3.000-5.000). Semua enak dan terjangkau!";
          } else if (budget === 'high') {
            reply = "Untuk Kak yang suka premium, saya rekomendasikan: üç≤ Soto Sokaraja (Rp 12.000-20.000) di Jl. Sokaraja, ü•ò Sop Ayam (Rp 15.000-25.000) di Jl. Gatot Subroto, dan ‚òï Kopi Joss (Rp 8.000-15.000) di Pasar Wage.";
          } else {
            const randomFood = kulinerData[Math.floor(Math.random() * kulinerData.length)];
            reply = `Saya merekomendasikan ${randomFood.nama} (${randomFood.kategori}) di ${randomFood.alamat}. Buka jam ${randomFood.jam} dengan harga sekitar ${randomFood.harga}.`;
          }
        } 
        else if (input.toLowerCase().includes("soto")) {
          reply = "üçú Soto Sokaraja khas Purwokerto! Lokasinya di Jl. Sokaraja, buka jam 07:00-15:00 dengan harga Rp 12.000-20.000. Unik karena menggunakan kuah kaldu sapi dengan kacang. Cocok banget untuk makan siang!";
        }
        else if (input.toLowerCase().includes("mendoan")) {
          reply = "ü•¢ Tempe Mendoan khas Purwokerto bisa ditemukan di Pasar Sokaraja. Harganya terjangkau Rp 2.000-5.000 per potong. Tempe digoreng setengah matang sehingga renyah di luar tapi lembut di dalam. Perfect untuk cemilan!";
        }
        else if (input.toLowerCase().includes("hallo") || input.toLowerCase().includes("hai")) {
          const greeting = getPersonalizedGreeting();
          reply = greeting;
        }
        else if (input.toLowerCase().includes("cuaca")) {
          const weatherTemp = document.getElementById('weatherTemp').textContent;
          const weatherDesc = document.getElementById('weatherDetailsDesc').textContent;
          reply = `üå§Ô∏è Cuaca Purwokerto saat ini: ${weatherDesc}, suhu ${weatherTemp}.`;
        }
        else if (mood === 'hungry') {
          reply = "üçΩÔ∏è Kak lapar ya? Untuk makan berat saya sarankan: üçú Soto Sokaraja, ü•ò Bakso, atau üç≤ Sop Ayam. Semua mengenyangkan dan enak!";
        }
        else if (mood === 'thirsty') {
          reply = "ü•§ Kak haus? Coba minuman segar: ü•• Es Kelapa Muda, üçß Es Campur, atau ü•§ Es Dawet Ayu. Semua menyegarkan!";
        }
        else if (mood === 'snack') {
          reply = "üç° Untuk cemilan, saya sarankan: ü•¢ Tempe Mendoan, üç° Cenil, atau üç™ Klanting. Semua enak dan terjangkau!";
        }
        else if (preferences.includes('spicy')) {
          reply = "üå∂Ô∏è Kak suka pedas ya? Coba Tempe Mendoan dengan sambal, atau Soto Sokaraja yang bisa ditambah cabai. Keduanya ada level kepedasan yang bisa disesuaikan!";
        }
        else if (preferences.includes('sweet')) {
          reply = "üç∞ Kak suka manis? Perfect! Coba üç° Cenil, üçß Es Campur, atau ü•§ Es Dawet Ayu. Semua manis dan enak!";
        }
        else {
          reply = "Terima kasih pertanyaannya Kak! Di Purwokerto banyak kuliner khas seperti Soto Sokaraja, Tempe Mendoan, Getuk Goreng, dan lainnya. Mau cari makanan jenis apa? Saya bisa bantu rekomendasi yang sesuai dengan preferensi Kak!";
        }

        chatMessages.innerHTML += `
          <div class="message message-bot">
            ${reply}
            <div class="message-time">${timeString}</div>
          </div>
        `;
        scrollChatToBottom();
      }
    }

    // User context tracking
    let userContext = {
      preferences: [],
      budget: null,
      dietary: [],
      lastSearches: [],
      mood: null,
      timeOfDay: null
    };

    // Function to analyze user input and update context
    function updateUserContext(input) {
      const lowerInput = input.toLowerCase();
      
      // Check for reset command
      if (lowerInput.includes('reset') || lowerInput.includes('hapus') || lowerInput.includes('clear')) {
        resetUserContext();
        return 'preferences_reset';
      }
      
      // Detect budget preferences
      if (lowerInput.includes('murah') || lowerInput.includes('hemat') || lowerInput.includes('budget')) {
        userContext.budget = 'low';
      } else if (lowerInput.includes('mahal') || lowerInput.includes('premium') || lowerInput.includes('restoran')) {
        userContext.budget = 'high';
      }
      
      // Detect dietary preferences
      if (lowerInput.includes('vegetarian') || lowerInput.includes('sayur') || lowerInput.includes('tidak makan daging')) {
        userContext.dietary.push('vegetarian');
      }
      if (lowerInput.includes('halal') || lowerInput.includes('islam')) {
        userContext.dietary.push('halal');
      }
      if (lowerInput.includes('pedas') || lowerInput.includes('spicy')) {
        userContext.preferences.push('spicy');
      }
      if (lowerInput.includes('manis') || lowerInput.includes('dessert') || lowerInput.includes('kue')) {
        userContext.preferences.push('sweet');
      }
      
      // Detect mood
      if (lowerInput.includes('lapar') || lowerInput.includes('makan')) {
        userContext.mood = 'hungry';
      } else if (lowerInput.includes('haus') || lowerInput.includes('minum')) {
        userContext.mood = 'thirsty';
      } else if (lowerInput.includes('cemilan') || lowerInput.includes('snack')) {
        userContext.mood = 'snack';
      }
      
      // Detect time of day
      const now = new Date();
      const hour = now.getHours();
      if (hour >= 6 && hour < 11) {
        userContext.timeOfDay = 'breakfast';
      } else if (hour >= 11 && hour < 15) {
        userContext.timeOfDay = 'lunch';
      } else if (hour >= 15 && hour < 19) {
        userContext.timeOfDay = 'afternoon';
      } else {
        userContext.timeOfDay = 'dinner';
      }
      
      // Add to recent searches
      userContext.lastSearches.unshift(input);
      if (userContext.lastSearches.length > 5) {
        userContext.lastSearches.pop();
      }
    }

    // Function to reset user context
    function resetUserContext() {
      userContext = {
        preferences: [],
        budget: null,
        dietary: [],
        lastSearches: [],
        mood: null,
        timeOfDay: null
      };
    }

    // Function to get personalized greeting
    function getPersonalizedGreeting() {
      const now = new Date();
      const hour = now.getHours();
      let greeting = '';
      
      if (hour >= 5 && hour < 12) {
        greeting = 'Selamat pagi!';
      } else if (hour >= 12 && hour < 15) {
        greeting = 'Selamat siang!';
      } else if (hour >= 15 && hour < 18) {
        greeting = 'Selamat sore!';
      } else {
        greeting = 'Selamat malam!';
      }
      
      let contextInfo = '';
      if (userContext.budget) {
        contextInfo += ` Saya lihat Kak suka makanan ${userContext.budget === 'low' ? 'yang ekonomis' : 'premium'}.`;
      }
      if (userContext.preferences.length > 0) {
        contextInfo += ` Kak juga suka makanan ${userContext.preferences.join(', ')}.`;
      }
      
      return greeting + contextInfo + ' Ada yang bisa saya bantu untuk rekomendasi kuliner Purwokerto?';
    }

    async function getAIResponse(userInput) {
      const API_KEY = 'AIzaSyBx6wxIFqWHRB9JQBe2Cd5mjlnrGfnpRCw';
      
      // Update user context based on input
      const contextUpdate = updateUserContext(userInput);
      
      // Handle reset command
      if (contextUpdate === 'preferences_reset') {
        return "Baik Kak! Saya sudah menghapus semua preferensi Kak. Sekarang saya akan memberikan rekomendasi yang lebih umum. Ada yang bisa saya bantu?";
      }
      
      // Get current weather info for context
      const weatherTemp = document.getElementById('weatherTemp')?.textContent || '25¬∞C';
      const weatherDesc = document.getElementById('weatherDetailsDesc')?.textContent || 'Cerah';
      
      // Create personalized context with more specific instructions
      const context = `
        Anda adalah asisten kuliner personal untuk kota Purwokerto. Berikan rekomendasi yang disesuaikan dengan preferensi pengguna.
        
        INFORMASI KULINER PURWOKERTO:
        - Soto Sokaraja: kuah kaldu sapi dengan kacang, harga Rp 12.000-20.000, lokasi Jl. Sokaraja
        - Tempe Mendoan: tempe goreng setengah matang, harga Rp 2.000-5.000, lokasi Pasar Sokaraja
        - Getuk Goreng: singkong goreng dengan gula aren, harga Rp 5.000-10.000
        - Klanting: cemilan singkong berbentuk anting, harga Rp 5.000-10.000
        - Cenil: singkong kenyal berwarna-warni, harga Rp 3.000-5.000
        - Es Dawet Ayu: minuman segar dari tepung beras dan santan, harga Rp 5.000-8.000
        - Bakso: kuah kaldu hangat, harga Rp 10.000-18.000, lokasi Jl. Sudirman
        - Kopi Joss: kopi panas dengan arang menyala, harga Rp 8.000-15.000, lokasi Pasar Wage
        - Wedang Ronde: minuman hangat dengan bola-bola ketan, harga Rp 5.000-8.000, lokasi Pasar Sokaraja
        - Sop Ayam: kuah bening yang menghangatkan, harga Rp 15.000-25.000, lokasi Jl. Gatot Subroto
        - Es Kelapa Muda: menyegarkan di hari panas, harga Rp 8.000-12.000, lokasi Jl. Sudirman
        - Es Campur: berbagai buah dengan sirup dan es, harga Rp 6.000-10.000, lokasi Pasar Sokaraja
        - Es Cendol: minuman tradisional dengan santan, harga Rp 4.000-7.000, lokasi Jl. Gatot Subroto
        
        PREFERENSI PENGGUNA:
        - Budget: ${userContext.budget || 'tidak spesifik'}
        - Dietary: ${userContext.dietary.join(', ') || 'tidak ada batasan'}
        - Preferensi: ${userContext.preferences.join(', ') || 'tidak spesifik'}
        - Mood: ${userContext.mood || 'tidak spesifik'}
        - Waktu: ${userContext.timeOfDay || 'tidak spesifik'}
        - Pencarian terakhir: ${userContext.lastSearches.slice(0, 3).join(', ') || 'tidak ada'}
        
        CUACA SAAT INI: ${weatherDesc}, suhu ${weatherTemp}
        
        INSTRUKSI KHUSUS:
        1. Berikan rekomendasi yang disesuaikan dengan preferensi pengguna
        2. Jika pengguna mencari makanan murah, fokus pada makanan di bawah Rp 15.000
        3. Jika pengguna mencari makanan premium, sarankan restoran atau makanan dengan kualitas tinggi
        4. Jika pengguna vegetarian, sarankan makanan berbasis sayur
        5. Jika pengguna suka pedas, sarankan makanan dengan level kepedasan
        6. Jika pengguna suka manis, sarankan dessert atau minuman manis
        7. Sesuaikan dengan waktu makan (sarapan, makan siang, makan malam, cemilan)
        8. Berikan jawaban yang ramah, personal, dan dalam bahasa Indonesia
        9. Gunakan nama pengguna jika tersedia atau panggil dengan "Kak" atau "Mas/Mbak"
        10. Jika pengguna bertanya tentang makanan yang tidak ada dalam daftar, sarankan alternatif yang tersedia
        11. Berikan jawaban yang singkat, jelas, dan langsung ke inti
        12. Jika pengguna lapar, sarankan makanan berat. Jika haus, sarankan minuman
        13. Gunakan emoji yang sesuai untuk membuat jawaban lebih menarik
        14. Berikan 2-3 rekomendasi yang berbeda untuk variasi
      `;

      const prompt = `${context}\n\nUser: ${userInput}\n\nAssistant:`;

      try {
        // Add timeout to make it more responsive
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
        
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${API_KEY}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            contents: [{
              parts: [{
                text: prompt
              }]
            }],
            generationConfig: {
              temperature: 0.8,
              topK: 40,
              topP: 0.95,
              maxOutputTokens: 600,
            }
          }),
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        
        if (data.candidates && data.candidates[0] && data.candidates[0].content) {
          return data.candidates[0].content.parts[0].text;
        } else {
          throw new Error('Invalid response format');
        }
      } catch (error) {
        console.error('AI API Error:', error);
        if (error.name === 'AbortError') {
          throw new Error('Request timeout - using fallback response');
        }
        throw error;
      }
    }

    function showWeatherRec() {
      const weatherDesc = document.getElementById('weatherDetailsDesc').textContent;
      const currentTemp = parseInt(document.getElementById('weatherTemp').textContent);
      const weatherIcon = document.getElementById('weatherIcon').className;
      
      let recs = [];
      let weatherType = '';
      
      if (weatherDesc.toLowerCase().includes('hujan') || currentTemp < 24) {
        weatherType = 'Hujan/Dingin';
        recs = [
          { nama: "Soto Sokaraja", deskripsi: "kuah hangat dengan kacang", harga: "Rp 12.000-20.000", lokasi: "Jl. Sokaraja" },
          { nama: "Kopi Joss", deskripsi: "kopi panas dengan arang menyala", harga: "Rp 8.000-15.000", lokasi: "Pasar Wage" },
          { nama: "Bakso", deskripsi: "kuah kaldu hangat", harga: "Rp 10.000-18.000", lokasi: "Jl. Sudirman" },
          { nama: "Wedang Ronde", deskripsi: "minuman hangat dengan bola-bola ketan", harga: "Rp 5.000-8.000", lokasi: "Pasar Sokaraja" },
          { nama: "Sop Ayam", deskripsi: "kuah bening yang menghangatkan", harga: "Rp 15.000-25.000", lokasi: "Jl. Gatot Subroto" }
        ];
      } else if (weatherDesc.toLowerCase().includes('cerah') || currentTemp > 28) {
        weatherType = 'Cerah/Panas';
        recs = [
          { nama: "Es Dawet Ayu", deskripsi: "minuman segar dari tepung beras dan santan", harga: "Rp 5.000-8.000", lokasi: "Pasar Wage" },
          { nama: "Es Kelapa Muda", deskripsi: "menyegarkan di hari panas", harga: "Rp 8.000-12.000", lokasi: "Jl. Sudirman" },
          { nama: "Soto Dingin", deskripsi: "soto dengan kuah yang tidak terlalu panas", harga: "Rp 12.000-18.000", lokasi: "Jl. Sokaraja" },
          { nama: "Es Campur", deskripsi: "berbagai buah dengan sirup dan es", harga: "Rp 6.000-10.000", lokasi: "Pasar Sokaraja" },
          { nama: "Es Cendol", deskripsi: "minuman tradisional dengan santan", harga: "Rp 4.000-7.000", lokasi: "Jl. Gatot Subroto" }
        ];
      } else {
        weatherType = 'Berawan/Sedang';
        recs = [
          { nama: "Tempe Mendoan", deskripsi: "gorengan hangat yang gurih", harga: "Rp 2.000-5.000", lokasi: "Pasar Sokaraja" },
          { nama: "Lumpia Boom", deskripsi: "lumpia besar dengan isian beragam", harga: "Rp 8.000-15.000", lokasi: "Jl. Sudirman" },
          { nama: "Sahoun", deskripsi: "soun berkuah ayam yang gurih", harga: "Rp 10.000-15.000", lokasi: "Jl. Gatot Subroto" },
          { nama: "Nopia", deskripsi: "kue tradisional isi gula merah", harga: "Rp 3.000-6.000", lokasi: "Pasar Wage" },
          { nama: "Jenang Jaket", deskripsi: "dodol lembut dan manis", harga: "Rp 5.000-10.000", lokasi: "Pasar Sokaraja" }
        ];
      }
      
      // Create and show custom popup
      showWeatherPopup(weatherDesc, currentTemp, weatherIcon, weatherType, recs);
    }

    function showWeatherPopup(weatherDesc, currentTemp, weatherIcon, weatherType, recommendations) {
      // Remove existing popup if any
      const existingPopup = document.getElementById('weatherRecommendationPopup');
      if (existingPopup) {
        existingPopup.remove();
      }

      // Create popup container
      const popup = document.createElement('div');
      popup.id = 'weatherRecommendationPopup';
      popup.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        animation: fadeIn 0.3s ease;
      `;

      // Create popup content
      const popupContent = document.createElement('div');
      popupContent.style.cssText = `
        background: white;
        border-radius: 20px;
        padding: 30px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        position: relative;
      `;

      // Create header with close button
      const header = document.createElement('div');
      header.style.cssText = `
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
      `;

      const title = document.createElement('h2');
      title.textContent = 'üå§Ô∏è Rekomendasi Cuaca & Kuliner';
      title.style.cssText = `
        color: var(--red);
        margin: 0;
        font-size: 1.5rem;
        font-weight: 600;
      `;

      const closeBtn = document.createElement('button');
      closeBtn.innerHTML = '√ó';
      closeBtn.style.cssText = `
        background: none;
        border: none;
        font-size: 2rem;
        color: #999;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.3s ease;
      `;
      closeBtn.onmouseover = () => closeBtn.style.background = '#f0f0f0';
      closeBtn.onmouseout = () => closeBtn.style.background = 'transparent';
      closeBtn.onclick = () => popup.remove();

      header.appendChild(title);
      header.appendChild(closeBtn);

      // Create weather info section
      const weatherInfo = document.createElement('div');
      weatherInfo.style.cssText = `
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 20px;
        text-align: center;
      `;

      const weatherIconDiv = document.createElement('div');
      weatherIconDiv.innerHTML = `<i class="${weatherIcon}" style="font-size: 3rem; margin-bottom: 10px;"></i>`;
      
      const weatherText = document.createElement('div');
      weatherText.innerHTML = `
        <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 5px;">${weatherDesc}</div>
        <div style="font-size: 1.5rem; font-weight: 700;">${currentTemp}¬∞C</div>
        <div style="font-size: 0.9rem; opacity: 0.9; margin-top: 5px;">Purwokerto</div>
      `;

      weatherInfo.appendChild(weatherIconDiv);
      weatherInfo.appendChild(weatherText);

      // Create filter section
      const filterSection = document.createElement('div');
      filterSection.style.cssText = `
        margin-bottom: 20px;
        text-align: center;
      `;

      const filterLabel = document.createElement('div');
      filterLabel.textContent = 'Filter berdasarkan:';
      filterLabel.style.cssText = `
        font-weight: 600;
        color: var(--text);
        margin-bottom: 10px;
      `;

      const filterButtons = document.createElement('div');
      filterButtons.style.cssText = `
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
      `;

      const filterOptions = [
        { id: 'all', label: 'Semua', color: '#c53e4e' },
        { id: 'makanan', label: 'Makanan', color: '#2980b9' },
        { id: 'minuman', label: 'Minuman', color: '#27ae60' },
        { id: 'snack', label: 'Snack', color: '#f39c12' }
      ];

      let currentFilter = 'all';
      let filteredRecs = recommendations;

      filterOptions.forEach(option => {
        const btn = document.createElement('button');
        btn.textContent = option.label;
        btn.style.cssText = `
          padding: 8px 16px;
          border: none;
          border-radius: 20px;
          background: ${option.id === 'all' ? option.color : '#f0f0f0'};
          color: ${option.id === 'all' ? 'white' : '#666'};
          cursor: pointer;
          font-size: 0.9rem;
          font-weight: 500;
          transition: all 0.3s ease;
        `;
        
        btn.onclick = () => {
          // Update button styles
          filterButtons.querySelectorAll('button').forEach(b => {
            b.style.background = '#f0f0f0';
            b.style.color = '#666';
          });
          btn.style.background = option.color;
          btn.style.color = 'white';
          
          // Filter recommendations
          currentFilter = option.id;
          if (currentFilter === 'all') {
            filteredRecs = recommendations;
          } else {
            filteredRecs = recommendations.filter(rec => {
              if (currentFilter === 'makanan') {
                return rec.nama.toLowerCase().includes('soto') || rec.nama.toLowerCase().includes('bakso') || 
                       rec.nama.toLowerCase().includes('sop') || rec.nama.toLowerCase().includes('sahoun');
              } else if (currentFilter === 'minuman') {
                return rec.nama.toLowerCase().includes('es') || rec.nama.toLowerCase().includes('kopi') || 
                       rec.nama.toLowerCase().includes('wedang');
              } else if (currentFilter === 'snack') {
                return rec.nama.toLowerCase().includes('mendoan') || rec.nama.toLowerCase().includes('lumpia') || 
                       rec.nama.toLowerCase().includes('nopia') || rec.nama.toLowerCase().includes('jenang');
              }
              return true;
            });
          }
          
          // Update recommendations display
          updateRecommendationsDisplay();
        };
        
        filterButtons.appendChild(btn);
      });

      filterSection.appendChild(filterLabel);
      filterSection.appendChild(filterButtons);

      // Create recommendations section
      const recommendationsSection = document.createElement('div');
      recommendationsSection.id = 'recommendationsContainer';

      function updateRecommendationsDisplay() {
        recommendationsSection.innerHTML = '';
        
        if (filteredRecs.length === 0) {
          const noResults = document.createElement('div');
          noResults.textContent = 'Tidak ada rekomendasi untuk filter ini.';
          noResults.style.cssText = `
            text-align: center;
            color: #999;
            padding: 20px;
            font-style: italic;
          `;
          recommendationsSection.appendChild(noResults);
          return;
        }

        filteredRecs.forEach((rec, index) => {
          const recCard = document.createElement('div');
          recCard.style.cssText = `
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid var(--red);
            transition: all 0.3s ease;
            cursor: pointer;
          `;
          
          recCard.onmouseover = () => {
            recCard.style.transform = 'translateY(-2px)';
            recCard.style.boxShadow = '0 5px 15px rgba(0,0,0,0.1)';
          };
          
          recCard.onmouseout = () => {
            recCard.style.transform = 'translateY(0)';
            recCard.style.boxShadow = 'none';
          };

          recCard.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
              <h3 style="color: var(--red); margin: 0; font-size: 1.1rem;">${rec.nama}</h3>
              <span style="background: var(--red); color: white; padding: 4px 8px; border-radius: 10px; font-size: 0.8rem; font-weight: 600;">${weatherType}</span>
            </div>
            <p style="color: #666; margin: 0 0 10px 0; font-size: 0.9rem;">${rec.deskripsi}</p>
            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem;">
              <span style="color: #27ae60; font-weight: 600;">üí∞ ${rec.harga}</span>
              <span style="color: #2980b9; font-weight: 600;">üìç ${rec.lokasi}</span>
            </div>
          `;

          recommendationsSection.appendChild(recCard);
        });
      }

      // Initial display
      updateRecommendationsDisplay();

      // Assemble popup
      popupContent.appendChild(header);
      popupContent.appendChild(weatherInfo);
      popupContent.appendChild(filterSection);
      popupContent.appendChild(recommendationsSection);
      popup.appendChild(popupContent);

      // Add to body
      document.body.appendChild(popup);

      // Close on outside click
      popup.onclick = (e) => {
        if (e.target === popup) {
          popup.remove();
        }
      };

      // Auto close after 30 seconds
      setTimeout(() => {
        if (document.getElementById('weatherRecommendationPopup')) {
          popup.remove();
        }
      }, 30000);
    }

    // Initialize the app
    document.addEventListener('DOMContentLoaded', () => {
      renderMap();
      renderList();
      fetchWeather(); // Load weather data
      
      // Set personalized greeting
      const initialGreeting = document.getElementById('initialGreeting');
      if (initialGreeting) {
        initialGreeting.textContent = getPersonalizedGreeting();
      }
      
      // Refresh weather every 30 minutes
      setInterval(fetchWeather, 30 * 60 * 1000);
      
      // Search functionality
      document.getElementById("search").addEventListener("input", (e) => {
        const search = e.target.value;
        const category = document.getElementById("filter").value;
        renderList(search, category);
      });

      // Filter functionality
      document.getElementById("filter").addEventListener("change", (e) => {
        const search = document.getElementById("search").value;
        const category = e.target.value;
        renderList(search, category);
      });
      
      // Allow pressing Enter in chat
      document.getElementById("chatInput").addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendChat();
      });

      // Initialize chat scroll to bottom
      const chatMessages = document.getElementById("chatMessages");
      if (chatMessages) {
        // Scroll to bottom on page load
        scrollChatToBottom();
        
        // Set up MutationObserver to auto-scroll when new messages are added
        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
              // Check if any added nodes are message elements
              const hasNewMessages = Array.from(mutation.addedNodes).some(node => 
                node.nodeType === Node.ELEMENT_NODE && 
                (node.classList.contains('message') || node.querySelector('.message'))
              );
              
              if (hasNewMessages) {
                // Immediate scroll
                scrollChatToBottom();
                
                // Additional scroll after DOM update
                setTimeout(() => {
                  scrollChatToBottom();
                }, 10);
                
                // Final scroll after longer delay
                setTimeout(() => {
                  scrollChatToBottom();
                }, 100);
              }
            }
          });
        });
        
        // Start observing the chat messages container
        observer.observe(chatMessages, {
          childList: true,
          subtree: true
        });
        
        // Also add scroll event listener to ensure chat stays at bottom
        chatMessages.addEventListener('scroll', () => {
          // If user scrolls up, don't auto-scroll
          const isAtBottom = chatMessages.scrollTop + chatMessages.clientHeight >= chatMessages.scrollHeight - 10;
          if (!isAtBottom) {
            // User has scrolled up, don't force scroll
            return;
          }
        });
      }
    });
  </script>
</body>
</html>
